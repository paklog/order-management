asyncapi: 2.5.0
info:
  title: Order Management Events (CloudEvents)
  version: 1.0.1
  description: |
    This service publishes domain events related to the lifecycle of a fulfillment order.
    All events conform to the CloudEvents v1.0 specification and are explicitly defined.

servers:
  production:
    url: kafka-prod.example.com:9092
    protocol: kafka
    description: Production Kafka broker

channels:
  fulfillment.order_management.v1.events:
    description: A topic for all domain events originating from the Order Management Bounded Context.
    publish:
      summary: Publish an order management domain event.
      message:
        oneOf:
          - $ref: '#/components/messages/FulfillmentOrderReceived'
          - $ref: '#/components/messages/FulfillmentOrderValidated'
          - $ref: '#/components/messages/FulfillmentOrderInvalidated'
          - $ref: '#/components/messages/FulfillmentOrderCancelled'
          - $ref: '#/components/messages/FulfillmentOrderPartiallyAccepted'
          - $ref: '#/components/messages/FulfillmentOrderStockUnavailable'

components:
  messages:
    FulfillmentOrderReceived:
      name: fulfillment_order_received
      title: Fulfillment Order Received
      summary: Published when a new fulfillment order is successfully accepted by the system.
      contentType: application/cloudevents+json
      payload:
        $ref: "#/components/schemas/FulfillmentOrderReceivedCloudEvent"
        
    FulfillmentOrderValidated:
      name: fulfillment_order_validated
      title: Fulfillment Order Validated
      summary: Published when an order has passed all business rule validations and is ready for the warehouse.
      contentType: application/cloudevents+json
      payload:
        $ref: "#/components/schemas/FulfillmentOrderValidatedCloudEvent"

    FulfillmentOrderInvalidated:
      name: fulfillment_order_invalidated
      title: Fulfillment Order Invalidated
      summary: Published when an order fails business rule validation.
      contentType: application/cloudevents+json
      payload:
        $ref: "#/components/schemas/FulfillmentOrderInvalidatedCloudEvent"

    FulfillmentOrderCancelled:
      name: fulfillment_order_cancelled
      title: Fulfillment Order Cancelled
      summary: Published when an order has been successfully cancelled.
      contentType: application/cloudevents+json
      payload:
        $ref: "#/components/schemas/FulfillmentOrderCancelledCloudEvent"

    FulfillmentOrderPartiallyAccepted:
      name: fulfillment_order_partially_accepted
      title: Fulfillment Order Partially Accepted
      summary: Published when an order is accepted with partial fulfillment due to inventory constraints.
      contentType: application/cloudevents+json
      payload:
        $ref: "#/components/schemas/FulfillmentOrderPartiallyAcceptedCloudEvent"

    FulfillmentOrderStockUnavailable:
      name: fulfillment_order_stock_unavailable
      title: Fulfillment Order Stock Unavailable
      summary: Published when an order has stock unavailable for some or all items.
      contentType: application/cloudevents+json
      payload:
        $ref: "#/components/schemas/FulfillmentOrderStockUnavailableCloudEvent"

  schemas:
    # --- Explicit CloudEvent Definitions ---

    FulfillmentOrderReceivedCloudEvent:
      type: object
      required: [specversion, type, source, id, time, data]
      properties:
        specversion:
          type: string
          enum: ["1.0"]
        type:
          type: string
          enum: ["com.paklog.fulfillment.order.received"]
        source:
          type: string
          format: uri-reference
          example: "/fulfillment/order-management-service"
        subject:
          type: string
          description: The `order_id` of the fulfillment order.
        id:
          type: string
          format: uuid
        time:
          type: string
          format: date-time
        datacontenttype:
          type: string
          enum: ["application/json"]
        data:
          $ref: '#/components/schemas/FulfillmentOrderData'

    FulfillmentOrderValidatedCloudEvent:
      type: object
      required: [specversion, type, source, id, time, data]
      properties:
        specversion:
          type: string
          enum: ["1.0"]
        type:
          type: string
          enum: ["com.paklog.fulfillment.order.validated"]
        source:
          type: string
          format: uri-reference
          example: "/fulfillment/order-management-service"
        subject:
          type: string
        id:
          type: string
          format: uuid
        time:
          type: string
          format: date-time
        datacontenttype:
          type: string
          enum: ["application/json"]
        data:
          $ref: '#/components/schemas/FulfillmentOrderData'

    FulfillmentOrderInvalidatedCloudEvent:
      type: object
      required: [specversion, type, source, id, time, data]
      properties:
        specversion:
          type: string
          enum: ["1.0"]
        type:
          type: string
          enum: ["com.paklog.fulfillment.order.invalidated"]
        source:
          type: string
          format: uri-reference
          example: "/fulfillment/order-management-service"
        subject:
          type: string
        id:
          type: string
          format: uuid
        time:
          type: string
          format: date-time
        datacontenttype:
          type: string
          enum: ["application/json"]
        data:
          $ref: '#/components/schemas/FulfillmentOrderInvalidatedData'

    FulfillmentOrderCancelledCloudEvent:
      type: object
      required: [specversion, type, source, id, time, data]
      properties:
        specversion:
          type: string
          enum: ["1.0"]
        type:
          type: string
          enum: ["com.paklog.fulfillment.order.cancelled"]
        source:
          type: string
          format: uri-reference
          example: "/fulfillment/order-management-service"
        subject:
          type: string
        id:
          type: string
          format: uuid
        time:
          type: string
          format: date-time
        datacontenttype:
          type: string
          enum: ["application/json"]
        data:
          $ref: '#/components/schemas/FulfillmentOrderCancelledData'

    FulfillmentOrderPartiallyAcceptedCloudEvent:
      type: object
      required: [specversion, type, source, id, time, data]
      properties:
        specversion:
          type: string
          enum: ["1.0"]
        type:
          type: string
          enum: ["com.paklog.fulfillment.order.partially_accepted"]
        source:
          type: string
          format: uri-reference
          example: "/fulfillment/order-management-service"
        subject:
          type: string
          description: The order_id of the fulfillment order.
        id:
          type: string
          format: uuid
        time:
          type: string
          format: date-time
        datacontenttype:
          type: string
          enum: ["application/json"]
        data:
          $ref: '#/components/schemas/FulfillmentOrderPartiallyAcceptedData'

    FulfillmentOrderStockUnavailableCloudEvent:
      type: object
      required: [specversion, type, source, id, time, data]
      properties:
        specversion:
          type: string
          enum: ["1.0"]
        type:
          type: string
          enum: ["com.paklog.fulfillment.order.stock_unavailable"]
        source:
          type: string
          format: uri-reference
          example: "/fulfillment/order-management-service"
        subject:
          type: string
          description: The order_id of the fulfillment order.
        id:
          type: string
          format: uuid
        time:
          type: string
          format: date-time
        datacontenttype:
          type: string
          enum: ["application/json"]
        data:
          $ref: '#/components/schemas/FulfillmentOrderStockUnavailableData'

    # --- Domain-Specific Data Payloads ---

    FulfillmentOrderData:
      type: object
      properties:
        order:
          $ref: '#/components/schemas/FulfillmentOrder'

    FulfillmentOrderInvalidatedData:
      type: object
      required: [order_id, seller_fulfillment_order_id, reason]
      properties:
        order_id:
          type: string
          format: uuid
        seller_fulfillment_order_id:
          type: string
        reason:
          type: string
          description: The reason why the order was invalidated.
          example: "Insufficient stock for SKU item-xyz-789"

    FulfillmentOrderCancelledData:
      type: object
      required: [order_id, seller_fulfillment_order_id]
      properties:
        order_id:
          type: string
          format: uuid
        seller_fulfillment_order_id:
          type: string
        cancellation_reason:
          type: string
          example: "Cancelled at seller's request."

    FulfillmentOrderPartiallyAcceptedData:
      type: object
      required: [order, unfulfillable_items, total_items_requested, items_fulfillable, items_unfulfillable, summary]
      properties:
        order:
          $ref: '#/components/schemas/FulfillmentOrder'
        unfulfillable_items:
          type: array
          items:
            $ref: '#/components/schemas/UnfulfillableItem'
        total_items_requested:
          type: integer
          description: Total number of items requested in the order.
        items_fulfillable:
          type: integer
          description: Number of items that can be fulfilled.
        items_unfulfillable:
          type: integer
          description: Number of items that cannot be fulfilled.
        summary:
          type: string
          description: Human-readable summary of the partial fulfillment.
          example: "Order abc-123 partially accepted: 3 of 5 items can be fulfilled"

    FulfillmentOrderStockUnavailableData:
      type: object
      required: [order, unavailable_items, total_items_requested, items_unavailable, total_quantity_shortfall, summary]
      properties:
        order:
          $ref: '#/components/schemas/FulfillmentOrder'
        unavailable_items:
          type: array
          items:
            $ref: '#/components/schemas/UnfulfillableItem'
        total_items_requested:
          type: integer
          description: Total number of items requested in the order.
        items_unavailable:
          type: integer
          description: Number of items with insufficient stock.
        total_quantity_shortfall:
          type: integer
          description: Total quantity shortage across all unavailable items.
        summary:
          type: string
          description: Human-readable summary of the stock shortage.
          example: "Order abc-123 accepted with stock shortage: 2 of 5 items unavailable, total shortfall: 15 units"

    # --- Reusable Domain Model Schemas ---

    FulfillmentOrder:
      type: object
      properties:
        order_id:
          type: string
          format: uuid
        seller_fulfillment_order_id:
          type: string
        displayable_order_id:
          type: string
        displayable_order_date:
          type: string
          format: date-time
        displayable_order_comment:
          type: string
        shipping_speed_category:
          type: string
        destination_address:
          $ref: '#/components/schemas/Address'
        status:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        received_date:
          type: string
          format: date-time
        fulfillment_policy:
          type: string
          description: Controls how the system handles inventory availability.
          enum:
            - FILL_OR_KILL
            - FILL_ALL
            - FILL_ALL_AVAILABLE
        fulfillment_action:
          type: string
          description: Result of applying the fulfillment policy.
          enum:
            - COMPLETE
            - PARTIAL
            - UNFULFILLABLE
        unfulfillable_items:
          type: array
          description: List of items that cannot be fulfilled due to inventory constraints.
          items:
            $ref: '#/components/schemas/UnfulfillableItem'

    UnfulfillableItem:
      type: object
      description: An item that cannot be fulfilled due to inventory constraints.
      required:
        - seller_sku
        - seller_fulfillment_order_item_id
        - requested_quantity
        - available_quantity
        - unfulfillable_quantity
        - reason
      properties:
        seller_sku:
          type: string
          description: The seller's unique identifier for the item.
        seller_fulfillment_order_item_id:
          type: string
          description: The seller's unique identifier for the line item.
        requested_quantity:
          type: integer
          description: The quantity originally requested.
        available_quantity:
          type: integer
          description: The quantity actually available in inventory.
        unfulfillable_quantity:
          type: integer
          description: The shortage amount (requested - available).
        reason:
          type: string
          description: The reason why the item cannot be fulfilled.
          enum:
            - INSUFFICIENT_STOCK
            - SKU_NOT_FOUND
            - INVENTORY_SERVICE_ERROR
            - DISCONTINUED
            - BACKORDERED

    OrderItem:
      type: object
      required:
        - seller_sku
        - seller_fulfillment_order_item_id
        - quantity
      properties:
        seller_sku:
          type: string
        seller_fulfillment_order_item_id:
          type: string
        quantity:
          type: integer
          format: int32
          minimum: 1
        gift_message:
          type: string
        displayable_comment:
          type: string

    Address:
      type: object
      required:
        - name
        - address_line_1
        - city
        - state_or_region
        - postal_code
        - country_code
      properties:
        name:
          type: string
        address_line_1:
          type: string
        address_line_2:
          type: string
        city:
          type: string
        state_or_region:
          type: string
        postal_code:
          type: string
        country_code:
          type: string