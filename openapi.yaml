openapi: 3.0.3
info:
  title: Fulfillment Order Management API
  description: |
    RESTful API for managing the complete lifecycle of fulfillment orders within the Paklog platform.

    ## Overview
    This service is part of the Order Management bounded context and provides capabilities for:
    - Creating new fulfillment orders with flexible inventory policies
    - Retrieving order status and details
    - Canceling orders that haven't been shipped yet

    ## Architecture
    The API follows Domain-Driven Design (DDD) principles and implements an event-driven architecture.
    All state changes are published as CloudEvents to Kafka for downstream consumers.

    ## Idempotency
    All mutating operations support idempotency through the `Idempotency-Key` header, ensuring
    safe retries without duplicate order creation.

    ## Fulfillment Policies
    The API supports three inventory handling strategies:
    - **FILL_OR_KILL**: Atomic all-or-nothing fulfillment
    - **FILL_ALL**: Accept order despite stock shortages (notifies via events)
    - **FILL_ALL_AVAILABLE**: Partial fulfillment of available items only

    ## Related Resources
    - [AsyncAPI Specification](./asyncapi.yaml) - Domain events documentation
    - [Architecture Documentation](./docs/architecture.md) - System design details
  version: 1.0.0
  contact:
    name: Paklog Platform Team
    email: platform@paklog.com
    url: https://docs.paklog.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  x-logo:
    url: https://paklog.com/logo.png
    altText: Paklog Logo

servers:
  - url: https://api.paklog.com/fulfillment/order_management/v1
    description: Production server
  - url: https://api.staging.paklog.com/fulfillment/order_management/v1
    description: Staging server
  - url: http://localhost:8080/fulfillment/order_management/v1
    description: Local development server

tags:
  - name: Fulfillment Orders
    description: |
      Operations for managing fulfillment orders throughout their lifecycle.
      Includes order creation, retrieval, and cancellation capabilities.
  - name: Order Lifecycle
    description: |
      Operations that affect the state of an order, such as creation and cancellation.
      These operations trigger domain events that are published to downstream systems.

paths:
  /fulfillment_orders:
    post:
      tags:
        - Fulfillment Orders
        - Order Lifecycle
      summary: Create a new Fulfillment Order
      description: |
        Submits a new fulfillment order to the system for processing.

        ## Idempotency
        Clients must provide an `Idempotency-Key` header to guarantee that retries of this request
        are processed only once. The service maintains idempotency keys for 24 hours.

        ## Duplicate Detection
        The payload's `seller_fulfillment_order_id` must be unique across all orders. If an order
        with the same ID already exists, a 409 Conflict will be returned, regardless of the
        idempotency key.

        ## Fulfillment Policy Behavior
        The `fulfillment_policy` field controls how the system handles inventory availability:

        | Policy | Behavior | Response |
        |--------|----------|----------|
        | FILL_OR_KILL | Reject if any item unavailable | 400 Bad Request |
        | FILL_ALL | Accept despite shortages | 202 Accepted + Stock Unavailable Event |
        | FILL_ALL_AVAILABLE | Partial fulfillment | 202 Accepted + Partial Fulfillment Event |

        ## Asynchronous Processing
        This endpoint returns 202 Accepted immediately after validation. The actual order processing
        (inventory checks, warehouse routing, etc.) happens asynchronously. Clients should subscribe
        to domain events or poll the GET endpoint for status updates.

        ## Domain Events Published
        - `com.paklog.fulfillment.order.received` - Always published on successful creation
        - `com.paklog.fulfillment.order.partially_accepted` - When FILL_ALL_AVAILABLE results in partial fulfillment
        - `com.paklog.fulfillment.order.stock_unavailable` - When FILL_ALL encounters stock shortages
      operationId: create_fulfillment_order
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          description: |
            A unique key generated by the client to guarantee that retries of this request are
            processed only once. Recommended format: UUID v4. Keys are retained for 24 hours.
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: X-Correlation-ID
          in: header
          required: false
          description: |
            Optional correlation ID for distributed tracing. If not provided, the service will
            generate one and include it in the response headers.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        description: The fulfillment order details including items, shipping information, and fulfillment policy.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFulfillmentOrderRequest'
            examples:
              standard_order:
                summary: Standard shipping order
                description: A typical order with standard shipping and FILL_OR_KILL policy
                value:
                  seller_fulfillment_order_id: "seller-abc-123"
                  displayable_order_id: "ORD-2024-001"
                  displayable_order_date: "2024-01-15T10:30:00Z"
                  displayable_order_comment: "Thank you for your order!"
                  shipping_speed_category: "STANDARD"
                  destination_address:
                    name: "John Doe"
                    address_line_1: "123 Main Street"
                    address_line_2: "Apt 4B"
                    city: "New York"
                    state_or_region: "NY"
                    postal_code: "10001"
                    country_code: "US"
                  items:
                    - seller_sku: "SKU-WIDGET-001"
                      seller_fulfillment_order_item_id: "line-1"
                      quantity: 2
                      gift_message: "Happy Birthday!"
                      displayable_comment: "Handle with care"
                  fulfillment_policy: "FILL_OR_KILL"
              partial_fulfillment_order:
                summary: Order allowing partial fulfillment
                description: Order that accepts partial fulfillment if some items are unavailable
                value:
                  seller_fulfillment_order_id: "seller-xyz-789"
                  displayable_order_id: "ORD-2024-002"
                  displayable_order_date: "2024-01-15T14:00:00Z"
                  shipping_speed_category: "EXPEDITED"
                  destination_address:
                    name: "Jane Smith"
                    address_line_1: "456 Oak Avenue"
                    city: "Los Angeles"
                    state_or_region: "CA"
                    postal_code: "90001"
                    country_code: "US"
                  items:
                    - seller_sku: "SKU-GADGET-A"
                      seller_fulfillment_order_item_id: "item-1"
                      quantity: 5
                    - seller_sku: "SKU-GADGET-B"
                      seller_fulfillment_order_item_id: "item-2"
                      quantity: 3
                  fulfillment_policy: "FILL_ALL_AVAILABLE"
      responses:
        '202':
          description: |
            **Accepted** - The fulfillment order has been successfully received and queued for processing.

            The response includes the created order with its system-generated `order_id` and initial status.
            The `fulfillment_action` field indicates how the order will be processed based on inventory availability.
          headers:
            X-Correlation-ID:
              description: Correlation ID for distributed tracing
              schema:
                type: string
                format: uuid
            X-Request-ID:
              description: Unique identifier for this specific request
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FulfillmentOrder'
              examples:
                complete_fulfillment:
                  summary: All items can be fulfilled
                  value:
                    order_id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
                    seller_fulfillment_order_id: "seller-abc-123"
                    displayable_order_id: "ORD-2024-001"
                    displayable_order_date: "2024-01-15T10:30:00Z"
                    displayable_order_comment: "Thank you for your order!"
                    shipping_speed_category: "STANDARD"
                    destination_address:
                      name: "John Doe"
                      address_line_1: "123 Main Street"
                      address_line_2: "Apt 4B"
                      city: "New York"
                      state_or_region: "NY"
                      postal_code: "10001"
                      country_code: "US"
                    status: "RECEIVED"
                    items:
                      - seller_sku: "SKU-WIDGET-001"
                        seller_fulfillment_order_item_id: "line-1"
                        quantity: 2
                        gift_message: "Happy Birthday!"
                        displayable_comment: "Handle with care"
                    received_date: "2024-01-15T10:30:45Z"
                    fulfillment_policy: "FILL_OR_KILL"
                    fulfillment_action: "COMPLETE"
                partial_fulfillment:
                  summary: Partial fulfillment due to stock shortage
                  value:
                    order_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    seller_fulfillment_order_id: "seller-xyz-789"
                    displayable_order_id: "ORD-2024-002"
                    displayable_order_date: "2024-01-15T14:00:00Z"
                    shipping_speed_category: "EXPEDITED"
                    destination_address:
                      name: "Jane Smith"
                      address_line_1: "456 Oak Avenue"
                      city: "Los Angeles"
                      state_or_region: "CA"
                      postal_code: "90001"
                      country_code: "US"
                    status: "RECEIVED"
                    items:
                      - seller_sku: "SKU-GADGET-A"
                        seller_fulfillment_order_item_id: "item-1"
                        quantity: 5
                      - seller_sku: "SKU-GADGET-B"
                        seller_fulfillment_order_item_id: "item-2"
                        quantity: 3
                    received_date: "2024-01-15T14:00:30Z"
                    fulfillment_policy: "FILL_ALL_AVAILABLE"
                    fulfillment_action: "PARTIAL"
        '400':
          description: |
            **Bad Request** - The request failed validation. This can occur due to:
            - Missing required fields
            - Invalid field formats (e.g., invalid date, malformed postal code)
            - Business rule violations (e.g., order date in the future, quantity out of range)
            - FILL_OR_KILL policy with unavailable inventory
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                missing_fields:
                  summary: Missing required fields
                  value:
                    timestamp: "2024-01-15T10:30:00Z"
                    status: 400
                    error: "Validation Failed"
                    message: "Request validation failed. Please check the errors for details."
                    path: "/fulfillment_orders"
                    fieldErrors:
                      seller_fulfillment_order_id:
                        - "Seller fulfillment order ID is required"
                      items:
                        - "Order must have at least one item"
                invalid_address:
                  summary: Invalid address format
                  value:
                    timestamp: "2024-01-15T10:30:00Z"
                    status: 400
                    error: "Validation Failed"
                    message: "Request validation failed. Please check the errors for details."
                    path: "/fulfillment_orders"
                    fieldErrors:
                      destination_address.postal_code:
                        - "Postal code contains invalid characters"
                      destination_address.country_code:
                        - "Country code must be a valid ISO 3166-1 alpha-2 code"
        '409':
          description: |
            **Conflict** - A fulfillment order with the provided `seller_fulfillment_order_id` already exists.
            This indicates a duplicate order submission attempt.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2024-01-15T10:30:00Z"
                status: 409
                error: "Conflict"
                message: "A fulfillment order with seller_fulfillment_order_id 'seller-abc-123' already exists"
                path: "/fulfillment_orders"
        '422':
          description: |
            **Unprocessable Entity** - The request is syntactically valid but cannot be processed due to
            business logic constraints (e.g., inventory check failed for FILL_OR_KILL policy).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: |
            **Internal Server Error** - An unexpected error occurred during processing.
            The request can be safely retried with the same idempotency key.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /fulfillment_orders/{order_id}:
    get:
      tags:
        - Fulfillment Orders
      summary: Get Fulfillment Order by ID
      description: |
        Retrieves the current state and complete details of a specific fulfillment order
        using its system-generated unique identifier.

        ## Use Cases
        - Polling for order status updates after creation
        - Retrieving order details for customer service inquiries
        - Auditing and compliance reporting

        ## Response Details
        The response includes:
        - Complete order information (items, addresses, dates)
        - Current processing status
        - Fulfillment policy and action taken
        - Cancellation reason (if applicable)

        ## Caching
        Responses are cacheable with appropriate ETags. The service uses optimistic locking
        to ensure data consistency.
      operationId: get_fulfillment_order_by_id
      parameters:
        - name: order_id
          in: path
          required: true
          description: |
            The unique system-generated identifier (UUID) for the fulfillment order.
            This ID is returned in the response when creating an order.
          schema:
            type: string
            format: uuid
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
        - name: X-Correlation-ID
          in: header
          required: false
          description: Optional correlation ID for distributed tracing
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: |
            **OK** - The fulfillment order was found and returned successfully.
          headers:
            ETag:
              description: Entity tag for cache validation
              schema:
                type: string
            X-Correlation-ID:
              description: Correlation ID for distributed tracing
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FulfillmentOrder'
              examples:
                active_order:
                  summary: Active order in processing
                  value:
                    order_id: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
                    seller_fulfillment_order_id: "seller-abc-123"
                    displayable_order_id: "ORD-2024-001"
                    displayable_order_date: "2024-01-15T10:30:00Z"
                    displayable_order_comment: "Thank you for your order!"
                    shipping_speed_category: "STANDARD"
                    destination_address:
                      name: "John Doe"
                      address_line_1: "123 Main Street"
                      city: "New York"
                      state_or_region: "NY"
                      postal_code: "10001"
                      country_code: "US"
                    status: "PROCESSING"
                    items:
                      - seller_sku: "SKU-WIDGET-001"
                        seller_fulfillment_order_item_id: "line-1"
                        quantity: 2
                    received_date: "2024-01-15T10:30:45Z"
                    fulfillment_policy: "FILL_OR_KILL"
                    fulfillment_action: "COMPLETE"
                cancelled_order:
                  summary: Cancelled order
                  value:
                    order_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    seller_fulfillment_order_id: "seller-xyz-789"
                    displayable_order_id: "ORD-2024-002"
                    displayable_order_date: "2024-01-15T14:00:00Z"
                    shipping_speed_category: "EXPEDITED"
                    destination_address:
                      name: "Jane Smith"
                      address_line_1: "456 Oak Avenue"
                      city: "Los Angeles"
                      state_or_region: "CA"
                      postal_code: "90001"
                      country_code: "US"
                    status: "CANCELLED"
                    items:
                      - seller_sku: "SKU-GADGET-A"
                        seller_fulfillment_order_item_id: "item-1"
                        quantity: 5
                    received_date: "2024-01-15T14:00:30Z"
                    fulfillment_policy: "FILL_ALL_AVAILABLE"
                    fulfillment_action: "COMPLETE"
                    cancellation_reason: "Cancelled at seller's request"
        '404':
          description: |
            **Not Found** - No fulfillment order exists with the given ID.
            This could mean:
            - The order was never created
            - The order ID is malformed
            - The order has been purged (retention policy)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2024-01-15T10:30:00Z"
                status: 404
                error: "Not Found"
                message: "Fulfillment order with ID 'f47ac10b-58cc-4372-a567-0e02b2c3d479' not found"
                path: "/fulfillment_orders/f47ac10b-58cc-4372-a567-0e02b2c3d479"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /fulfillment_orders/{order_id}/cancel:
    post:
      tags:
        - Fulfillment Orders
        - Order Lifecycle
      summary: Cancel a Fulfillment Order
      description: |
        Requests the cancellation of a fulfillment order. This operation is only permitted
        when the order is in a cancellable state (not yet shipped or in final processing).

        ## Cancellation Rules
        Orders can be cancelled when in the following statuses:
        - RECEIVED
        - PROCESSING
        - PLANNING

        Orders **cannot** be cancelled when:
        - Already shipped (SHIPPED status)
        - Delivered (DELIVERED status)
        - Already cancelled (CANCELLED status)
        - In transit (IN_TRANSIT status)

        ## Asynchronous Processing
        This endpoint returns 202 Accepted immediately. The actual cancellation is processed
        asynchronously and a `com.paklog.fulfillment.order.cancelled` event is published
        upon successful cancellation.

        ## Idempotency
        Multiple cancellation requests for the same order are idempotent - if the order is
        already cancelled, the request succeeds without error.

        ## Domain Events Published
        - `com.paklog.fulfillment.order.cancelled` - Published when cancellation succeeds
      operationId: cancel_fulfillment_order
      parameters:
        - name: order_id
          in: path
          required: true
          description: |
            The unique system-generated identifier (UUID) for the fulfillment order to cancel.
          schema:
            type: string
            format: uuid
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
        - name: X-Correlation-ID
          in: header
          required: false
          description: Optional correlation ID for distributed tracing
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        description: Optional cancellation details
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelOrderRequest'
            example:
              reason: "Customer requested cancellation"
      responses:
        '202':
          description: |
            **Accepted** - The cancellation request has been accepted and is being processed.
            The order will be cancelled asynchronously.
          headers:
            X-Correlation-ID:
              description: Correlation ID for distributed tracing
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FulfillmentOrder'
        '400':
          description: |
            **Bad Request** - The order is not in a state that allows cancellation.
            This occurs when the order has already been shipped or is in a final state.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2024-01-15T10:30:00Z"
                status: 400
                error: "Bad Request"
                message: "Order cannot be cancelled: current status is SHIPPED"
                path: "/fulfillment_orders/f47ac10b-58cc-4372-a567-0e02b2c3d479/cancel"
        '404':
          description: |
            **Not Found** - No fulfillment order found with the given ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2024-01-15T10:30:00Z"
                status: 404
                error: "Not Found"
                message: "Fulfillment order with ID 'f47ac10b-58cc-4372-a567-0e02b2c3d479' not found"
                path: "/fulfillment_orders/f47ac10b-58cc-4372-a567-0e02b2c3d479/cancel"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CreateFulfillmentOrderRequest:
      type: object
      description: |
        Request payload for creating a new fulfillment order. Contains all necessary information
        for order processing including items, shipping details, and fulfillment preferences.
      required:
        - seller_fulfillment_order_id
        - displayable_order_id
        - displayable_order_date
        - shipping_speed_category
        - destination_address
        - items
        - fulfillment_policy
      properties:
        seller_fulfillment_order_id:
          type: string
          description: |
            A unique identifier for the order, provided by the seller. This ID is used for
            duplicate detection and must be unique across all orders in the system.
            Recommended format: combination of seller prefix and sequential number.
          maxLength: 255
          pattern: '^[a-zA-Z0-9_-]+$'
          example: "seller-abc-123"
        displayable_order_id:
          type: string
          description: |
            An identifier for the order that is shown to the recipient on packing slips
            and shipping labels. This is typically the customer-facing order number.
          maxLength: 255
          example: "ORD-2024-001"
        displayable_order_date:
          type: string
          format: date-time
          description: |
            The date of the order to be displayed on packing slips. Must be in ISO 8601 format
            and cannot be in the future. This date represents when the customer placed the order.
          example: "2024-01-15T10:30:00Z"
        displayable_order_comment:
          type: string
          description: |
            A comment for the order that is shown to the recipient on the packing slip.
            Typically used for thank you messages, special instructions, or promotional content.
          maxLength: 500
          example: "Thank you for your order! We appreciate your business."
        shipping_speed_category:
          type: string
          description: |
            The requested shipping speed for the order. This determines the service level
            agreement (SLA) for order processing and delivery timeframes.

            | Category | Typical SLA |
            |----------|-------------|
            | STANDARD | 5-7 business days |
            | EXPEDITED | 3-5 business days |
            | PRIORITY | 2-3 business days |
            | NEXT_DAY | Next business day |
            | SAME_DAY | Same day delivery |
            | SCHEDULED | Customer-specified date |
          enum:
            - STANDARD
            - EXPEDITED
            - PRIORITY
            - SAME_DAY
            - NEXT_DAY
            - SCHEDULED
          example: "STANDARD"
        destination_address:
          $ref: '#/components/schemas/Address'
        items:
          type: array
          description: |
            List of items to fulfill in this order. Each item must have a valid SKU and quantity.
            The order must contain at least 1 item and no more than 100 items.
          minItems: 1
          maxItems: 100
          items:
            $ref: '#/components/schemas/OrderItem'
        fulfillment_policy:
          type: string
          description: |
            Controls how the system handles inventory availability during order processing.
            This policy determines the system's behavior when requested items are not fully available.

            **FILL_OR_KILL** (Atomic Fulfillment)
            - Reject the entire order if any item is unavailable
            - No partial fulfillment allowed
            - Returns 400 Bad Request if inventory check fails
            - Best for: Orders where all items must ship together

            **FILL_ALL** (Accept with Notification)
            - Accept the order even if items are unavailable
            - Publishes `FulfillmentOrderStockUnavailableEvent` with shortage details
            - Order proceeds with backorder or procurement workflow
            - Best for: Non-critical orders, items with known replenishment

            **FILL_ALL_AVAILABLE** (Partial Fulfillment)
            - Accept the order and fulfill only available items
            - Unavailable items are removed from the order
            - Publishes `FulfillmentOrderPartiallyAcceptedEvent` with details
            - Best for: Maximizing immediate fulfillment, handling shortages gracefully
          enum:
            - FILL_OR_KILL
            - FILL_ALL
            - FILL_ALL_AVAILABLE
          example: "FILL_ALL_AVAILABLE"

    FulfillmentOrder:
      type: object
      description: |
        Complete representation of a fulfillment order, including its current state,
        processing details, and all associated metadata. This is the primary response
        object for order-related operations.
      properties:
        order_id:
          type: string
          format: uuid
          description: |
            The unique system-generated identifier for the fulfillment order.
            This UUID is assigned by the system upon order creation and is used
            for all subsequent operations.
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
        seller_fulfillment_order_id:
          type: string
          description: The seller-provided unique identifier for this order.
          example: "seller-abc-123"
        displayable_order_id:
          type: string
          description: Customer-facing order identifier shown on packing slips.
          example: "ORD-2024-001"
        displayable_order_date:
          type: string
          format: date-time
          description: The order date displayed to customers.
          example: "2024-01-15T10:30:00Z"
        displayable_order_comment:
          type: string
          description: Comment displayed on packing slips.
          example: "Thank you for your order!"
        shipping_speed_category:
          type: string
          description: The shipping speed selected for this order.
          enum:
            - STANDARD
            - EXPEDITED
            - PRIORITY
            - SAME_DAY
            - NEXT_DAY
            - SCHEDULED
          example: "STANDARD"
        destination_address:
          $ref: '#/components/schemas/Address'
        status:
          type: string
          description: |
            The current processing status of the fulfillment order. Status transitions
            follow a defined state machine and trigger corresponding domain events.

            | Status | Description |
            |--------|-------------|
            | RECEIVED | Order received and validated |
            | PROCESSING | Order being prepared for fulfillment |
            | PLANNING | Warehouse routing and picking optimization |
            | SHIPPED | Order has been shipped |
            | IN_TRANSIT | Order in transit to destination |
            | DELIVERED | Order successfully delivered |
            | CANCELLED | Order has been cancelled |
            | INVALID | Order failed validation |
          enum:
            - RECEIVED
            - PROCESSING
            - PLANNING
            - SHIPPED
            - IN_TRANSIT
            - DELIVERED
            - CANCELLED
            - INVALID
          example: "RECEIVED"
        items:
          type: array
          description: List of items in the fulfillment order.
          items:
            $ref: '#/components/schemas/OrderItem'
        received_date:
          type: string
          format: date-time
          description: |
            The timestamp when the order was received by the system (UTC).
            This marks the official start of order processing.
          example: "2024-01-15T10:30:45Z"
        fulfillment_policy:
          type: string
          description: The fulfillment policy applied to this order.
          enum:
            - FILL_OR_KILL
            - FILL_ALL
            - FILL_ALL_AVAILABLE
          example: "FILL_OR_KILL"
        fulfillment_action:
          type: string
          description: |
            The result of applying the fulfillment policy based on inventory availability.
            This field indicates how the order was processed.

            **COMPLETE**
            - All requested items are available and will be fulfilled
            - No inventory constraints encountered

            **PARTIAL**
            - Only some items can be fulfilled (FILL_ALL_AVAILABLE policy)
            - Unavailable items have been removed from the order
            - Details provided in `FulfillmentOrderPartiallyAcceptedEvent`

            **UNFULFILLABLE**
            - No items can be fulfilled
            - Typically occurs with complete stock-out scenarios

            Note: Detailed information about unfulfillable items is provided asynchronously
            via domain events rather than in this synchronous response.
          enum:
            - COMPLETE
            - PARTIAL
            - UNFULFILLABLE
          example: "COMPLETE"
        cancellation_reason:
          type: string
          description: |
            The reason for order cancellation, if applicable. Only present when
            status is CANCELLED.
          example: "Customer requested cancellation"

    OrderItem:
      type: object
      description: |
        Represents a single line item in a fulfillment order. Each item corresponds to
        a specific product (SKU) with its requested quantity and optional personalization.
      required:
        - seller_sku
        - seller_fulfillment_order_item_id
        - quantity
      properties:
        seller_sku:
          type: string
          description: |
            The seller's unique identifier for the product (Stock Keeping Unit).
            This SKU must match a product in the inventory system.
          maxLength: 255
          pattern: '^[a-zA-Z0-9_-]+$'
          example: "SKU-WIDGET-001"
        seller_fulfillment_order_item_id:
          type: string
          description: |
            The seller's unique identifier for this specific line item within the order.
            Used for tracking individual items across the fulfillment process.
          maxLength: 255
          example: "line-item-1"
        quantity:
          type: integer
          format: int32
          description: |
            The quantity of this item to fulfill. Must be a positive integer between
            1 and 10,000. Large quantities may be split across multiple shipments.
          minimum: 1
          maximum: 10000
          example: 2
        gift_message:
          type: string
          description: |
            Optional gift message to include with the item. This message will be
            printed on a gift card or label and included in the package.
          maxLength: 500
          example: "Happy Birthday! Hope you enjoy this gift."
        displayable_comment:
          type: string
          description: |
            Optional comment to display on the packing slip for this specific item.
            Useful for special handling instructions or item-specific notes.
          maxLength: 500
          example: "Fragile - Handle with care"

    Address:
      type: object
      description: |
        Shipping address for the fulfillment order. Represents the destination where
        the order will be delivered. All addresses are validated for proper formatting.
      required:
        - name
        - address_line_1
        - city
        - state_or_region
        - postal_code
        - country_code
      properties:
        name:
          type: string
          description: |
            Full name of the recipient. This name appears on shipping labels
            and is used by carriers for delivery.
          maxLength: 255
          example: "John Doe"
        address_line_1:
          type: string
          description: |
            Primary street address including house/building number and street name.
            This is the main delivery address line.
          maxLength: 255
          example: "123 Main Street"
        address_line_2:
          type: string
          description: |
            Secondary address information such as apartment number, suite, floor,
            or building name. Optional field for additional location details.
          maxLength: 255
          example: "Apt 4B"
        city:
          type: string
          description: City or municipality name for the delivery address.
          maxLength: 100
          example: "New York"
        state_or_region:
          type: string
          description: |
            State, province, region, or territory. Format varies by country
            (e.g., "NY" for US states, "ON" for Canadian provinces).
          maxLength: 100
          example: "NY"
        postal_code:
          type: string
          description: |
            Postal or ZIP code for the delivery address. Format varies by country.
            Must contain only alphanumeric characters, spaces, and hyphens.
            Examples: "10001" (US), "M5V 3L9" (Canada), "SW1A 1AA" (UK).
          maxLength: 20
          pattern: '^[A-Za-z0-9\s-]+$'
          example: "10001"
        country_code:
          type: string
          description: |
            Two-letter ISO 3166-1 alpha-2 country code in uppercase.
            Examples: "US" (United States), "CA" (Canada), "GB" (United Kingdom).
          minLength: 2
          maxLength: 2
          pattern: '^[A-Z]{2}$'
          example: "US"

    UnfulfillableItem:
      type: object
      description: |
        Represents an item that cannot be fulfilled due to inventory constraints.
        This schema is used in domain events to provide detailed information about
        stock shortages and fulfillment failures.
      required:
        - seller_sku
        - seller_fulfillment_order_item_id
        - requested_quantity
        - available_quantity
        - unfulfillable_quantity
        - reason
      properties:
        seller_sku:
          type: string
          description: The seller's unique identifier for the product.
          example: "SKU-001"
        seller_fulfillment_order_item_id:
          type: string
          description: The seller's unique identifier for this line item.
          example: "line-item-1"
        requested_quantity:
          type: integer
          description: The quantity originally requested in the order.
          example: 10
        available_quantity:
          type: integer
          description: |
            The quantity actually available in inventory at the time of processing.
            This represents what can be fulfilled.
          example: 3
        unfulfillable_quantity:
          type: integer
          description: |
            The shortage amount, calculated as (requested - available).
            Represents the quantity that cannot be fulfilled.
          example: 7
        reason:
          type: string
          description: |
            The specific reason why the item cannot be fulfilled. This helps
            downstream systems determine appropriate actions.

            | Reason | Description | Typical Action |
            |--------|-------------|----------------|
            | INSUFFICIENT_STOCK | Not enough inventory | Backorder or substitute |
            | SKU_NOT_FOUND | Product doesn't exist | Review catalog |
            | INVENTORY_SERVICE_ERROR | System error | Retry later |
            | DISCONTINUED | Product no longer available | Offer alternative |
            | BACKORDERED | Known future availability | Wait for restock |
          enum:
            - INSUFFICIENT_STOCK
            - SKU_NOT_FOUND
            - INVENTORY_SERVICE_ERROR
            - DISCONTINUED
            - BACKORDERED
          example: "INSUFFICIENT_STOCK"

    CancelOrderRequest:
      type: object
      description: Optional request body for order cancellation with reason.
      properties:
        reason:
          type: string
          description: |
            The reason for cancelling the order. This information is stored
            with the order and included in the cancellation event.
          maxLength: 500
          example: "Customer requested cancellation"

    ValidationErrorResponse:
      type: object
      description: |
        Structured error response returned when request validation fails.
        Provides detailed information about which fields failed validation
        and why, enabling clients to fix issues and retry.
      required:
        - timestamp
        - status
        - error
        - message
        - path
      properties:
        timestamp:
          type: string
          format: date-time
          description: UTC timestamp when the error occurred.
          example: "2024-01-15T10:30:00Z"
        status:
          type: integer
          description: HTTP status code (always 400 for validation errors).
          example: 400
        error:
          type: string
          description: Error type classification.
          example: "Validation Failed"
        message:
          type: string
          description: Human-readable summary of the validation failure.
          example: "Request validation failed. Please check the errors for details."
        path:
          type: string
          description: The API path that was requested.
          example: "/fulfillment_orders"
        fieldErrors:
          type: object
          description: |
            Map of field names to their validation error messages. Keys are
            field paths using dot notation for nested objects.
          additionalProperties:
            type: array
            items:
              type: string
          example:
            seller_fulfillment_order_id:
              - "Seller fulfillment order ID is required"
            items:
              - "Order must have at least one item"
            destination_address.postal_code:
              - "Postal code contains invalid characters"

    ErrorResponse:
      type: object
      description: |
        Generic error response for non-validation errors such as conflicts,
        not found, or server errors.
      required:
        - timestamp
        - status
        - error
        - message
        - path
      properties:
        timestamp:
          type: string
          format: date-time
          description: UTC timestamp when the error occurred.
          example: "2024-01-15T10:30:00Z"
        status:
          type: integer
          description: HTTP status code.
          example: 404
        error:
          type: string
          description: Error type classification.
          example: "Not Found"
        message:
          type: string
          description: Human-readable error message with specific details.
          example: "Fulfillment order with ID 'f47ac10b-58cc-4372-a567-0e02b2c3d479' not found"
        path:
          type: string
          description: The API path that was requested.
          example: "/fulfillment_orders/f47ac10b-58cc-4372-a567-0e02b2c3d479"

externalDocs:
  description: Complete API documentation and guides
  url: https://docs.paklog.com/fulfillment/order-management
